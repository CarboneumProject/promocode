<!DOCTYPE html>
<html lang="en">
<head>
    <title>Carboneum Redeem Code</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <style>
        /* Remove the navbar's default margin-bottom and rounded borders */
        .navbar {
            margin-bottom: 0;
            border-radius: 0;
        }

        /* Set height of the grid so .sidenav can be 100% (adjust as needed) */
        .row.content {
            height: 450px
        }

        /* Set gray background color and 100% height */
        .sidenav {
            padding-top: 20px;
            background-color: #f1f1f1;
            height: 100%;
        }

        /* Set black background color, white text and some padding */
        footer {
            background-color: #555;
            color: white;
            padding: 15px;
        }

        /* On small screens, set height to 'auto' for sidenav and grid */
        @media screen and (max-width: 767px) {
            .sidenav {
                height: auto;
                padding: 15px;
            }

            .row.content {
                height: auto;
            }
        }

        .wordwrap {
            white-space: pre-wrap; /* css-3 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -pre-wrap; /* Opera 4-6 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="container-fluid">
        <div class="collapse navbar-collapse" id="myNavbar">
            <img src="carboneum.png" class="img-responsive center-block" style="height: 80px">
        </div>
    </div>
</nav>

<div class="container-fluid text-center">
    <div class="row">
        <div class="col-sm-12 text-center">
            <h2>Your promo code is:</h2>
            <h2 id="promocode">-</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-2">
        </div>
        <div class="col-sm-8 text-center">
            <div class="text-center">
                <div>
                    <button onclick="redeem()" class="btn button">
                        Redeem
                    </button>
                </div>
                <p id="message" class="wordwrap" style="height: 40px; margin-top: 20px;"></p>
            </div>
        </div>
        <div class="col-sm-2">
        </div>
    </div>
</div>

<script>
  let url_string = window.location.href;
  let url = new URL(url_string);
  let code = url.searchParams.get('c');
  let signature = url.searchParams.get('s');
  document.getElementById('promocode').innerHTML = '<b>' + code + '</b>';
  console.log(code, signature);

  function showMsg(msg) {
    document.getElementById('message').innerHTML = msg;
  }

  function redeem() {
    const PromoCodeABI = [
      {
        "constant": false,
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "owner",
        "outputs": [
          {
            "name": "",
            "type": "address"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "amount",
        "outputs": [
          {
            "name": "",
            "type": "uint256"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [
          {
            "name": "",
            "type": "bytes32"
          }
        ],
        "name": "used",
        "outputs": [
          {
            "name": "",
            "type": "bool"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {
            "name": "_newOwner",
            "type": "address"
          }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "token",
        "outputs": [
          {
            "name": "",
            "type": "address"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "name": "_token",
            "type": "address"
          },
          {
            "name": "_amount",
            "type": "uint256"
          }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "name": "user",
            "type": "address"
          },
          {
            "indexed": false,
            "name": "amount",
            "type": "uint256"
          },
          {
            "indexed": false,
            "name": "code",
            "type": "string"
          }
        ],
        "name": "Redeem",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "name": "previousOwner",
            "type": "address"
          }
        ],
        "name": "OwnershipRenounced",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "name": "previousOwner",
            "type": "address"
          },
          {
            "indexed": true,
            "name": "newOwner",
            "type": "address"
          }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
      },
      {
        "constant": false,
        "inputs": [
          {
            "name": "_amount",
            "type": "uint256"
          }
        ],
        "name": "setAmount",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {
            "name": "promoCode",
            "type": "string"
          },
          {
            "name": "signature",
            "type": "bytes"
          }
        ],
        "name": "redeem",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [
          {
            "name": "message",
            "type": "string"
          },
          {
            "name": "v",
            "type": "uint8"
          },
          {
            "name": "r",
            "type": "bytes32"
          },
          {
            "name": "s",
            "type": "bytes32"
          }
        ],
        "name": "verifyString",
        "outputs": [
          {
            "name": "signer",
            "type": "address"
          }
        ],
        "payable": false,
        "stateMutability": "pure",
        "type": "function"
      }
    ];
    let contractAddress = '0xb2d34eccf8ea3a79705d7b0b41c47c5351b48779';
    const mainnet = '1';
    const rinkeby = '4';
    let subdomain = '';

    // Detect whether the current browser is ethereum-compatible,
    // and handle the case where it isn't:
    if (typeof window.ethereum === 'undefined') {
      showMsg('Looks like you need a Dapp browser to get started.' +
        ' Consider installing <a target="_blank" href="https://metamask.io/">MetaMask!</a>');
    } else {

      // In the case the user has MetaMask installed, you can easily
      // ask them to sign in and reveal their accounts:
      ethereum.enable()

      // Remember to handle the case they reject the request:
        .catch(function (reason) {
          if (reason === 'User rejected provider access') {
            // The user didn't want to sign in!
          } else {
            // This shouldn't happen, so you might want to log this...
            showMsg('There was an issue signing you in.')
          }
        })

        // In the case they approve the log-in request, you'll receive their accounts:
        .then(function (accounts) {
          console.log(ethereum.networkVersion);
          // You also should verify the user is on the correct network:
          if (ethereum.networkVersion === mainnet) {
            contractAddress = '0xb2d34eccf8ea3a79705d7b0b41c47c5351b48779';
          } else if (ethereum.networkVersion === rinkeby) {
            contractAddress = '0x5807d311d872e81709de391a8ad13f9e16c5443b';
            subdomain = 'rinkeby.'
          } else {
            showMsg('This application requires the mainnet or rinkeby network, please switch it in your MetaMask UI.');
            return;
          }

          // Once you have a reference to user accounts,
          // you can suggest transactions and signatures:
          if (typeof web3 !== 'undefined') {
            // Use Mist/MetaMask's provider
            web3js = new Web3(web3.currentProvider);
          } else {
            showMsg('No web3? You should consider trying MetaMask!');
            // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
            web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
          }
          const account = accounts[0];
          const promoCode = web3js.eth.contract(PromoCodeABI).at(contractAddress);
          promoCode.redeem(code, signature,
            {from: account, gas: 100000, gasPrice: 8000000000},
            function (err, transaction) {
              if (err) {
                return showMsg(`Fail to redeem token`);
              }
              let txLink = `https://${subdomain}etherscan.io/tx/${transaction}`;
              showMsg(`Please wait for tx: <a target="_blank" href="${txLink}">${transaction}</a>`);
            })
        })
    }
  }
</script>
</body>
</html>
